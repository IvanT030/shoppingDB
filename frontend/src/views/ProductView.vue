<template>
  <div>
    <!-- 頁面標題 -->
    <DefaultPage :pageTitle="'商品管理'" />

    <button class="btn" @click="back">回主頁</button> <br><br>
    <button class="btn" @click="insert"> 新增商品 </button>

    <!-- 商品列表 -->
    <ProductList 
      :products="products" 
      @view-detail="viewDetail" 
    />

    <!-- 商品詳細資訊 -->
    <ProductDetail
      v-if="selectedProduct"
      :product="selectedProduct"
      @close="closeDetail"
      @saveData="saveProduct"
    />

    <ProductCreateForm
      v-if="showCreateForm"
      @close="closeCreateForm"
      @save="addProduct"
    />

  </div>
</template>

<script setup>
  import { ref, onMounted } from 'vue';
  import { useRouter } from 'vue-router';
  import axios from 'axios';
  import DefaultPage from '@/components/DefaultPage.vue';
  import ProductList from '@/components/ProductList.vue';
  import ProductDetail from '@/components/ProductDetail.vue';
  import ProductCreateForm from '@/components/ProductCreateForm.vue';

  const products = ref([]);
  const selectedProduct = ref(null);
  const router = useRouter()
  const showCreateForm = ref(false);

  const fetchProducts = async () => {
    try {
      const response = await axios.get("http://localhost/mytest/products");
      console.log(response)
      products.value = response.data.map(product => ({
        id: product.ProductID,
        name: product.ProductName,
        category: product.Category,
        price: product.Price,
        stock: product.Stock,
        salesVolume: product.SaleVolume
      }));
    } catch (error) {
      alert('获取商品失败')
    }
  }

  onMounted(fetchProducts);

  const back = () =>{
    router.push({name: 'branch'})
  }

  const insert = () => {
    showCreateForm.value = true;
  };

  const closeCreateForm = () => {
    showCreateForm.value = false;
  };

  const addProduct = async (newProduct) => {
    /*
    newProduct = {
      name: 'asd', 
      category: 'asd', 
      price: 456, 
      stock: 456, 
      salesVolume: 456}
    }
    */
    try {
      //這樣直接POST下去 後端查看直接是NULL值 因為這個修改的是VSCODE的
      await axios.post("http://localhost/mytest/products", newProduct);
      products.value.push(newProduct); // 新增到本地數據
      alert("商品新增成功！");
    } catch (error) {
      alert("商品新增失敗！");
    } finally {
      closeCreateForm();
    }
  };

  const viewDetail = (product) => {
    selectedProduct.value = product;
  };

  const closeDetail = () => {
    selectedProduct.value = null;
  };

  const saveProduct = async (updatedProduct) => {
    console.log('from here', updatedProduct);
    try {
      await axios.put(`http://localhost/mytest/products/${updatedProduct.id}`, updatedProduct);
      const index = products.value.findIndex((p) => p.id === updatedProduct.id);
      if (index !== -1) products.value.splice(index, 1, updatedProduct);
    } catch (error) {
      alert('保存商品失败');
    }
  };
</script>

<style>
#app {
  font-family: Arial, sans-serif;
  text-align: center;
}

/* 商品詳細資訊視窗樣式 */
#detail {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 50%;
  max-width: 600px;
  padding: 20px;
  background-color: aliceblue;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 1000;
}

.btn {
  background-color: #2ecc71;
  color: b6b6b6;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.btn:hover {
  background-color: #27ae60;
}
</style>
